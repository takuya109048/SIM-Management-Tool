{% extends "layout.html" %}

{% block title %}
{{ form_title or '契約フォーム' }}
{% endblock %}

{% block content %}
<h1>{{ form_title or '契約フォーム' }}</h1>

<form method="post">
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="carrier_name" class="form-label">キャリア名</label>
            <input type="text" class="form-control" id="carrier_name" name="carrier_name" list="carrier_names" value="{{ contract.carrier_name or '' }}">
            <datalist id="carrier_names">
                {% for carrier in all_carriers %}
                    <option value="{{ carrier.carrier_name }}">
                {% endfor %}
            </datalist>
        </div>
        <div class="col-md-6 mb-3">
            <label for="plan_name" class="form-label">プラン名</label>
            <input type="text" class="form-control" id="plan_name" name="plan_name" list="plan_names" value="{{ contract.plan_name or '' }}">
            <datalist id="plan_names">
                {# Options will be populated by JavaScript #}
            </datalist>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="contract_date" class="form-label">契約日</label>
            <input type="date" class="form-control" id="contract_date" name="contract_date" value="{{ contract.contract_date or '' }}">
        </div>
        <div class="col-md-6 mb-3">
            <label for="scheduled_termination_date" class="form-label">解約予定日</label>
            <input type="date" class="form-control" id="scheduled_termination_date" name="scheduled_termination_date" value="{{ contract.scheduled_termination_date or '' }}">
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="phone_number" class="form-label">電話番号</label>
            <input type="text" class="form-control" id="phone_number" name="phone_number" value="{{ contract.phone_number or '' }}">
        </div>
        <div class="col-md-6 mb-3">
            <label for="contractor_name" class="form-label">契約者名</label>
            <input type="text" class="form-control" id="contractor_name" name="contractor_name" value="{{ contract.contractor_name or '' }}">
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="sim_id_last_5_digits" class="form-label">SIM ID下5桁</label>
            <input type="text" class="form-control" id="sim_id_last_5_digits" name="sim_id_last_5_digits" value="{{ contract.sim_id_last_5_digits or '' }}">
        </div>
    </div>

    <hr>

    <div class="row">
        <div class="col-md-4 mb-3">
            <label for="initial_fee" class="form-label">事務手数料</label>
            <input type="number" class="form-control" id="initial_fee" name="initial_fee" value="{{ contract.initial_fee or 0 }}">
        </div>
        <div class="col-md-4 mb-3">
            <label for="first_month_cost" class="form-label">初月費用</label>
            <input type="number" class="form-control" id="first_month_cost" name="first_month_cost" value="{{ contract.first_month_cost or 0 }}">
        </div>
        <div class="col-md-4 mb-3">
            <label for="monthly_cost" class="form-label">月額費用</label>
            <input type="number" class="form-control" id="monthly_cost" name="monthly_cost" value="{{ contract.monthly_cost or 0 }}">
        </div>
    </div>

    <div class="row">
        <div class="col-md-4 mb-3">
            <label for="cashback_amount" class="form-label">キャッシュバック額</label>
            <input type="number" class="form-control" id="cashback_amount" name="cashback_amount" value="{{ contract.cashback_amount or 0 }}">
        </div>
    </div>

    <hr>

    <div class="row">
        <div class="col-md-4 mb-3">
            <label for="device_type" class="form-label">購入端末の種類</label>
            <input type="text" class="form-control" id="device_type" name="device_type" value="{{ contract.device_type or '' }}">
        </div>
        <div class="col-md-4 mb-3">
            <label for="device_cost" class="form-label">購入端末費用</label>
            <input type="number" class="form-control" id="device_cost" name="device_cost" value="{{ contract.device_cost or 0 }}">
        </div>
        <div class="col-md-4 mb-3">
            <label for="device_resale_value" class="form-label">購入端末売却額</label>
            <input type="number" class="form-control" id="device_resale_value" name="device_resale_value" value="{{ contract.device_resale_value or 0 }}">
        </div>
    </div>

    <div class="mb-3">
        <label for="memo" class="form-label">メモ</label>
        <textarea class="form-control" id="memo" name="memo" rows="3">{{ contract.memo or '' }}</textarea>
    </div>

    <button type="submit" class="btn btn-success">契約を保存</button>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">キャンセル</a>
</form>

<script>
    const allCarriersData = {{ all_carriers | tojson }};

    document.addEventListener('DOMContentLoaded', function() {
        const carrierInput = document.getElementById('carrier_name');
        const planInput = document.getElementById('plan_name');
        const planDatalist = document.getElementById('plan_names');
        const initialFeeInput = document.getElementById('initial_fee');
        const contractDateInput = document.getElementById('contract_date');
        const scheduledTerminationDateInput = document.getElementById('scheduled_termination_date');

        function updatePlans() {
            const selectedCarrierName = carrierInput.value;
            planDatalist.innerHTML = '<option value="">プランを選択</option>'; // Clear existing options in datalist

            if (selectedCarrierName) {
                const selectedCarrier = allCarriersData.find(c => c.carrier_name === selectedCarrierName);
                if (selectedCarrier && selectedCarrier.plans) {
                    selectedCarrier.plans.forEach(plan => {
                        const option = document.createElement('option');
                        option.value = plan.plan_name;
                        planDatalist.appendChild(option);
                    });
                }
            }
        }

        function updateInitialFeeAndTerminationDate() {
            const selectedCarrierName = carrierInput.value;
            const selectedPlanName = planInput.value;
            
            if (selectedCarrierName && selectedPlanName) {
                const selectedCarrier = allCarriersData.find(c => c.carrier_name === selectedCarrierName);
                if (selectedCarrier && selectedCarrier.plans) {
                    const selectedPlan = selectedCarrier.plans.find(p => p.plan_name === selectedPlanName);
                    if (selectedPlan) {
                        // Auto-fill initial fee
                        initialFeeInput.value = selectedPlan.initial_fee;

                        // Auto-calculate scheduled termination date
                        if (contractDateInput.value && selectedPlan.minimum_maintenance_period >= 0) {
                            const contractDate = new Date(contractDateInput.value);
                            const terminationDate = new Date(contractDate);
                            terminationDate.setDate(contractDate.getDate() + selectedPlan.minimum_maintenance_period);
                            scheduledTerminationDateInput.value = terminationDate.toISOString().split('T')[0];
                        }
                    }
                }
            }
        }

        // Initial population of plan datalist based on pre-selected carrier (for edit mode)
        if (carrierInput.value) {
            updatePlans(); // Populate plans if carrier is already set (edit mode)
        }

        carrierInput.addEventListener('change', updatePlans);
        planInput.addEventListener('change', updateInitialFeeAndTerminationDate);
        contractDateInput.addEventListener('change', updateInitialFeeAndTerminationDate);

        

        
    });
</script>
{% endblock %}