### 携帯SIM管理アプリ：要件定義

#### 1. アプリの目的
複数のSIM契約情報を一元管理し、MNPやプラン変更による契約の連鎖を追跡しながら、コストや収支を可視化する。

#### 2. 言語とインターフェース
* **言語:** Python
* **フレームワーク:** Flask
* **データベース形式:** JSON
* **ユーザーインターフェース:** Webインターフェース

#### 3. JSONデータベースの構造
データベースはJSON形式のリストで、各契約をJSONオブジェクトとして管理する。`contract_id` が各オブジェクトのユニークな識別子となる。

#### 4. 契約マスターテーブルの定義

| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| **contract_id** | `TEXT` / `INTEGER` | **主キー**。各契約を一意に識別するID。 |
| **previous_contract_id** | `TEXT` / `INTEGER` | **前回契約のID**。MNPやプラン変更で契約が連鎖する場合に、前の契約を指す。 |
| **contract_date** | `DATE` | 契約日。 |
| **scheduled_termination_date** | `DATE` | 予定解約日。契約を終了する予定の日付。 |
| **phone_number** | `TEXT` | 契約に紐づく電話番号。 |
| **contractor_name** | `TEXT` | 契約者名。 |
| **carrier_name** | `TEXT` | 通信事業者名（例：ドコモ、au、ソフトバンク、楽天モバイル）。 |
| **plan_name** | `TEXT` | 契約している料金プラン名。 |
| **sim_id_last_5_digits** | `TEXT` | SIM IDの末尾5桁。eSIMの場合は「NA」。 |
| **initial_fee** | `INTEGER` | 事務手数料。 |
| **first_month_cost** | `INTEGER` | 初月費用。 |
| **monthly_cost** | `INTEGER` | 月額費用（月の維持費）。 |
| **cashback_amount** | `INTEGER` | キャッシュバック額（任意）。 |
| **device_type** | `TEXT` | 購入端末の種類（任意）。 |
| **device_cost** | `INTEGER` | 購入端末費用（任意）。 |
| **device_resale_value** | `INTEGER` | 購入端末売却額（任意）。 |
| **memo** | `TEXT` | 自由なメモ。 |

#### 5. アプリケーションで計算する項目（計算カラム）とエラーハンドリング
計算処理にはエラーハンドリングを徹底する。一つの契約の計算エラーが、全体の計算を停止させないように実装する。

* **予定維持日数:**
    * `contract_date` または `scheduled_termination_date` が不正な場合、計算をスキップし、該当契約の維持日数は`null`または`-`として表示する。
* **維持月数:**
    * 日付が不正な場合、計算をスキップし、該当契約の維持月数は`null`または`-`として表示する。
* **契約ごとの収支:**
    * 計算に使用する数値データが不正な場合、該当項目を`0`として計算を続行する。
    * 維持月数の計算でエラーが発生した場合は、その部分を`0`として計算を続行する。
    * 計算が完了できなかった場合は、その契約の収支を`null`または`-`として扱い、全体の収支計算からは除外する。
* **チェーン全体の最終収支:**
    * **計算:** 同じ`phone_number`で連鎖している契約全体の「契約ごとの収支」を合算する。
    * **エラーハンドリング:**
        * `previous_contract_id`が指す契約が存在しない場合は、チェーンが途切れたものとして、存在する契約のみを合算する。
        * 各契約の収支計算でエラーが発生した場合（`null`または`-`となった場合）は、その契約の収支は`0`として合算するのではなく、無視して合算処理を続行する。

#### 6. 入力画面の要件

**新規契約・既存契約編集画面**
* **入力形式:** Webフォーム形式で各項目を入力・編集する。
* **契約ID:** 
    * **新規契約時:** 契約保存時に自動的に一意の`contract_id`を生成する。
    * **契約編集時:** `contract_id`は変更不可とする。
* **データ保存:** 「保存」ボタンをクリックすることで、入力・編集内容を保存する。

#### 7. キャリアマスターテーブル連携機能
* **キャリア選択:** 入力画面の「`carrier_name`」項目では、キャリアマスターに登録されたキャリアのリストから選択する。
* **連動入力:** キャリアを選択した場合、関連する項目がマスターデータに基づいて自動入力される。
    * **プラン選択:** 選択したキャリアに紐づくプランのリストから選択できる。
    * **事務手数料自動入力:** 選択したプランに設定されている事務手数料（`initial_fee`）を自動的に入力する。ユーザーによる手動での変更も可能。
    * **解約日自動入力:** 「`contract_date`（契約日）」を入力した際、選択済みのプランに設定されている最低維持期間（`minimum_maintenance_period`）を考慮し、自動的に「`scheduled_termination_date`（予定解約日）」を計算して入力する。ユーザーによる手動での変更も可能。
