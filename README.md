### 携帯SIM管理アプリ：要件定義

#### 1. アプリの目的
複数のSIM契約情報を一元管理し、MNPやプラン変更による契約の連鎖を追跡しながら、コストや収支を可視化する。

#### 2. 言語とインターフェース
* **言語:** Python
* **フレームワーク:** Flask
* **データ永続化:** JSONファイル
* **ユーザーインターフェース:** Webインターフェース
* **国際化:** 国際化機能は削除され、UIは日本語に統一されています。

#### 3. 認証機能
* **ユーザー登録:** ユーザーはアカウントを作成できる。
* **ログイン:** 登録したユーザーはログインしてアプリケーションを使用できる。
* **データ紐付け:** 登録された契約情報は、各ユーザーアカウントに紐づけて管理される。

#### 4. データ構造
データはJSONファイルで保存され、以下の構造を持つ。

##### 4.1. ユーザーマスターテーブルの定義

| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| **id** | `INTEGER` | **主キー**。各ユーザーを一意に識別するID。 |
| **username** | `TEXT` | ユーザー名。 |
| **password_hash** | `TEXT` | ハッシュ化されたパスワード。 |

##### 4.2. 契約マスターテーブルの定義

| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| **id** | `INTEGER` | **主キー**。 |
| **contract_id** | `TEXT` | 各契約を一意に識別するID。 |
| **user_id** | `INTEGER` | **外部キー**。ユーザーマスターテーブルの`id`を参照する。 |

| **contract_date** | `DATE` | 契約日。 |
| **scheduled_termination_date** | `DATE` | 予定解約日。契約を終了する予定の日付。 |
| **phone_number** | `TEXT` | 契約に紐づく電話番号。 |
| **contractor_name** | `TEXT` | 契約者名。 |
| **carrier_name** | `TEXT` | 通信事業者名（例：ドコモ、au、ソフトバンク、楽天モバイル）。 |
| **plan_name** | `TEXT` | 契約している料金プラン名。 |
| **sim_id_last_5_digits** | `TEXT` | SIM IDの末尾5桁。eSIMの場合は「NA」。 |
| **initial_fee** | `INTEGER` | 事務手数料。 |
| **first_month_cost** | `INTEGER` | 初月費用。 |
| **monthly_cost** | `INTEGER` | 月額費用（月の維持費）。 |
| **cashback_amount** | `INTEGER` | キャッシュバック額（任意）。 |
| **device_type** | `TEXT` | 購入端末の種類（任意）。 |
| **device_cost** | `INTEGER` | 購入端末費用（任意）。 |
| **device_resale_value** | `INTEGER` | 購入端末売却額（任意）。 |
| **memo** | `TEXT` | 自由なメモ。 |

##### 4.3. キャリアマスターテーブルの定義

| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| **id** | `INTEGER` | **主キー**。各キャリアを一意に識別するID。 |
| **name** | `TEXT` | キャリア名（例：ドコモ、au）。 |

##### 4.4. プランマスターテーブルの定義

| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| **id** | `INTEGER` | **主キー**。各プランを一意に識別するID。 |
| **carrier_id** | `INTEGER` | **外部キー**。キャリアマスターテーブルの`id`を参照する。 |
| **plan_name** | `TEXT` | プラン名。 |
| **initial_fee** | `INTEGER` | 事務手数料。 |
| **minimum_maintenance_period** | `INTEGER` | 最低維持期間（月数）。 |

#### 5. アプリケーションで計算する項目（計算カラム）とエラーハンドリング
計算処理にはエラーハンドリングを徹底する。一つの契約の計算エラーが、全体の計算を停止させないように実装する。

* **予定維持日数:**
    * `contract_date` または `scheduled_termination_date` が不正な場合、計算をスキップし、該当契約の維持日数は`null`または`-`として表示する。
* **維持月数:**
    * 日付が不正な場合、計算をスキップし、該当契約の維持月数は`null`または`-`として表示する。
* **契約ごとの収支:**
    * 計算結果は、**プラスが利益、マイナスが損失**を示す。
    * 計算に使用する数値データが不正な場合、該当項目を`0`として計算を続行する。
    * 維持月数の計算でエラーが発生した場合は、その部分を`0`として計算を続行する。
    * 計算が完了できなかった場合は、その契約の収支を`null`または`-`として扱い、全体の収支計算からは除外する。
* **過去契約を含めた総収支:**
    * **計算:** 同じ`phone_number`を持つ契約を、契約日と解約予定日を考慮して関連付け、それらの契約全体の「契約ごとの収支」を合算する。
    * **エラーハンドリング:**
        * 各契約の収支計算でエラーが発生した場合（`null`または`-`となった場合）は、その契約の収支は無視して合算処理を続行する。

#### 6. 入力画面の要件

**新規契約・既存契約編集画面**
* **入力形式:** Webフォーム形式で各項目を入力・編集する。
* **契約ID:** 
    * **新規契約時:** 契約保存時に自動的に一意の`contract_id`を生成する。
    * **契約編集時:** `contract_id`は変更不可とする。
* **データ保存:** 「保存」ボタンをクリックすることで、入力・編集内容を保存する。


#### 7. キャリアマスターテーブル連携機能
* **キャリア選択:** 入力画面の「`carrier_name`」項目では、キャリアマスターに登録されたキャリアのリストから選択する。
* **連動入力:** キャリアを選択した場合、関連する項目がマスターデータに基づいて自動入力される。
    * **プラン選択:** 選択したキャリアに紐づくプランのリストから選択できる。
    * **事務手数料自動入力:** 選択したプランに設定されている事務手数料（`initial_fee`）を自動的に入力する。ユーザーによる手動での変更も可能。
    * **解約日自動入力:** 「`contract_date`（契約日）」を入力した際、選択済みのプランに設定されている最低維持期間（`minimum_maintenance_period`）を考慮し、自動的に「`scheduled_termination_date`（予定解約日）」を計算して入力する。ユーザーによる手動での変更も可能。

### 機能仕様書

#### 1. アプリケーション概要
本アプリケーションは、複数の携帯SIM契約情報を一元的に管理し、MNPやプラン変更による契約の連鎖を追跡しながら、各契約および契約チェーン全体のコストと収支を可視化することを目的としています。Webインターフェースを通じて利用し、データはJSONファイル形式で永続化されます。国際化機能は削除され、ユーザーインターフェースは日本語に統一されています。

#### 2. 認証機能
*   **ユーザー登録**: 新規ユーザーはアカウントを作成し、アプリケーションにアクセスできます。
*   **ログイン**: 登録済みのユーザーは、ユーザー名とパスワードでログインし、自身の契約情報を管理できます。
*   **データ紐付け**: 登録された契約情報は、ログイン中のユーザーアカウントに紐づけて管理され、他のユーザーからは参照できません。

#### 3. 契約管理機能
*   **新規契約の追加**: Webフォームを通じて、新しいSIM契約情報を登録できます。契約保存時に一意の`contract_id`が自動生成されます。
    
*   **既存契約の編集**: 登録済みの契約情報をWebフォームで編集できます。`contract_id`は変更できません。
    
*   **契約の削除**: 不要になった契約情報を削除できます。
*   **契約の連鎖追跡**: 同じ電話番号を持つ契約を契約日と解約予定日を考慮して関連付けることで、MNPやプラン変更による契約の連鎖を追跡し、関連する契約情報を把握できます。

#### 4. キャリア・プラン連携機能
*   **キャリア選択**: 契約登録・編集画面で、登録済みのキャリアリストから`carrier_name`を選択できます。
*   **プランの動的表示**: 選択されたキャリアに紐づくプランが動的に表示され、その中から`plan_name`を選択できます。
*   **事務手数料の自動入力**: 選択されたプランに設定されている`initial_fee`が自動的に入力されます。ユーザーによる手動での変更も可能です。
*   **予定解約日の自動計算**: `contract_date`と選択されたプランの`minimum_maintenance_period`に基づき、`scheduled_termination_date`が自動計算されます。ユーザーによる手動での変更も可能です。

#### 5. 収支計算機能
アプリケーションは以下の項目を自動で計算し、表示します。計算処理にはエラーハンドリングが組み込まれており、一部のデータが不正でも全体の計算が停止しないように設計されています。
*   **予定維持日数**: `contract_date`と`scheduled_termination_date`から計算されます。日付が不正な場合は計算をスキップし、`null`または`-`として表示されます。
*   **維持月数**: `contract_date`と`scheduled_termination_date`から計算されます。日付が不正な場合は計算をスキップし、`null`または`-`として表示されます。
*   **契約ごとの収支**: 各契約の`initial_fee`, `first_month_cost`, `monthly_cost`, `cashback_amount`, `device_cost`, `device_resale_value`、および維持月数を用いて計算されます。**計算結果は、プラスが利益、マイナスが損失を示します。** 数値データが不正な場合は`0`として計算を続行し、計算が完了できない場合は`null`または`-`として扱われます。
*   **過去契約を含めた総収支**: 同じ`phone_number`を持つ契約を、契約日と解約予定日を考慮して関連付け、それらの契約全体の「契約ごとの収支」を合算して計算されます。各契約の収支計算でエラーが発生した場合は、その契約の収支は無視して合算処理が続行されます。

#### 6. 契約一覧表示機能
アプリケーションのメイン画面である契約一覧には、以下の情報が表示されます。
*   **契約ID**: 各契約を一意に識別するID。
*   **キャリア名**: 契約している通信事業者名。
*   **電話番号**: 契約に紐づく電話番号。
*   **契約者名**: 契約者名。
*   **契約日**: 契約が開始された日付。
*   **解約予定日**: 契約が終了する予定の日付。
*   **収支**: その契約単体での収支。
*   **過去契約を含めた総収支**: 同じ電話番号を持つ契約を契約日と解約予定日を考慮して関連付けた、チェーン全体の総収支。
*   **操作**: 契約の編集や削除を行うためのボタン。

#### 7. データ永続化
*   すべてのアプリケーションデータ（ユーザー、契約、キャリア、プラン）は、ローカルファイルシステム上のJSONファイルとして保存されます。
*   `data/users.json`、`data/contracts.json`、`data/carriers.json`（キャリアとプラン情報を含む）が使用されます。
*   アプリケーション起動時に、これらのファイルが存在しない場合は自動的に初期化されます。また、デフォルトのキャリアとプランデータが自動的に追加されます。